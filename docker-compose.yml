services:
  # SSL Certificate Generator (runs first to ensure certificates exist)
  ssl-init:
    image: alpine:latest
    container_name: ssl-init
    command: sh -c "apk add --no-cache openssl && sh /generate-ssl.sh"
    volumes:
      - ./ssl:/ssl
      - ./generate-ssl.sh:/generate-ssl.sh:ro
    environment:
      CUSTOM_DOMAIN: ${CUSTOM_DOMAIN}
    restart: 'no'

  # GTM Preview Server (must start first)
  gtm-preview:
    image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
    container_name: gtm-preview
    ports:
      # Node.js debugging
      - '9228:9228'
    environment:
      # sGTM env
      CONTAINER_CONFIG: ${CONTAINER_CONFIG}
      RUN_AS_PREVIEW_SERVER: 'true'
      # Node.js debugging env
      NODE_OPTIONS: ${DEBUGGING_ENABLED:+--inspect=0.0.0.0:9228}
    restart: unless-stopped
    networks:
      - gtm-network
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_SERVER:-0}'
          memory: '${MEMORY_LIMIT_SERVER:-0}'
    healthcheck:
      test:
        [
          'CMD',
          '/nodejs/bin/node',
          '-e',
          "require('http').get('http://localhost:8080/healthy', (res) => { if (res.statusCode === 200) { process.exit(0) } else { process.exit(1) } }).on('error', (err) => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # GTM Live Server (starts after preview)
  gtm-live:
    image: gcr.io/cloud-tagging-10302018/gtm-cloud-image:stable
    container_name: gtm-live
    ports:
      # Node.js debugging
      - '9229:9229'
    environment:
      # sGTM env
      CONTAINER_CONFIG: ${CONTAINER_CONFIG}
      PREVIEW_SERVER_URL: 'https://host.docker.internal:8889'
      CONTAINER_REFRESH_SECONDS: ${CONTAINER_REFRESH_SECONDS}
      NODE_TLS_REJECT_UNAUTHORIZED: '0'
      # Node.js debugging env
      NODE_OPTIONS: ${DEBUGGING_ENABLED:+--inspect=0.0.0.0:9229}
    depends_on:
      - gtm-preview
    restart: unless-stopped
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - gtm-network
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT_SERVER:-0}'
          memory: '${MEMORY_LIMIT_SERVER:-0}'
    healthcheck:
      test:
        [
          'CMD',
          '/nodejs/bin/node',
          '-e',
          "require('http').get('http://localhost:8080/healthy', (res) => { if (res.statusCode === 200) { process.exit(0) } else { process.exit(1) } }).on('error', (err) => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Nginx HTTPS Reverse Proxy for GTM servers
  nginx:
    image: nginx:alpine
    container_name: gtm-nginx
    ports:
      - '${PORT_TAGGING_SERVER}:8888' # Live server port
      - '443:8888' # Live server Default HTTPS port
      - '${PORT_PREVIEW_SERVER}:8889' # Preview server port
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      ssl-init:
        condition: service_completed_successfully
      gtm-live:
        condition: service_started
      gtm-preview:
        condition: service_started
    restart: unless-stopped
    networks:
      - gtm-network

networks:
  gtm-network:
    driver: bridge
